{% extends "layout.html" %}

{% block content %}
  <!-- Our Tours Section -->
  <div class="tour-wrapper">
    <h1 class="tour-header">Our Tours</h1>

    <div class="tour-cards-container">
      <!-- Tour Cards (unchanged) -->


      <div class="tour-card">
        <h5 class="tour-card-title">Full Island Tour</h5>
        <p class="tour-card-text">
          Indiana Jones, Lara Croft, you name it! Adrenaline and curiosity drive the way you go.
          You want to see it all: Mountain climbing, boat adventures, exploring remote caves.
        </p>
        <br>
        <a href="#booking-form-tour" class="tour-btn">Book the Tour</a>
        <a href="/tour/explorer" class="learn-more-text">Learn More</a>
      </div>
      
      <div class="tour-card">
        <h5 class="tour-card-title">Trekking Tour</h5>
        <p class="tour-card-text">
          If ‘I’m sexy and I know it’ is your motto? This is the package for you! 
          For the local celebrity, the divas, and everyone that loves photography.
          <br><br><br>
        </p>
        <a href="#booking-form-tour" class="tour-btn">Book the Tour</a>
        <a href="/tour/photographer" class="learn-more-text">Learn More</a>
      </div>

      <div class="tour-card">
        <h5 class="tour-card-title">Beach Lover</h5>
        <p class="tour-card-text">
          So you probably heard of the pristine beaches and the turquoise waters of Socotra. 
          If the beach is calling you, you can never refuse. Enjoy unforgettable views and activities!
        </p>
        <br>
        <a href="#booking-form-tour" class="tour-btn">Book the Tour</a>
        <a href="/tour/beach-potato" class="learn-more-text">Learn More</a>
      </div>

      <div class="tour-card">
        <h5 class="tour-card-title">The VIP</h5>
        <p class="tour-card-text">
          You are the boss, determined and adventurous but enjoy comfort. Customize your itinerary 
          with a private consultation to make the tour exactly what you want.
        </p>
        <br><br>
        <a href="#booking-form-tour" class="tour-btn">Book the Tour</a>
        <a href="/tour/vip" class="learn-more-text">Learn More</a>
      </div>
    </div>
  </div>

  <!-- Included / Not Included (unchanged) -->
  <div class="included">
    <h1 class="included-header">What is Included?</h1>
    <div class="included-card">
      <img src="{{ url_for('static', filename='images/newtent.png') }}" alt="Lodging" class="included-card-img" />
      <h5 class="included-title-inside">Lodging</h5>
      <p class="included-text">Clean, comfortable tents or hotels (upon request)</p>
    </div>
    <div class="included-card">
      <img src="{{ url_for('static', filename='images/newfood.png') }}" alt="Food" class="included-card-img" />
      <h5 class="included-title-inside">Food</h5>
      <p class="included-text">Delicious locally sourced meals and snacks</p>
    </div>
    <div class="included-card">
      <img src="{{ url_for('static', filename='images/newmap.png') }}" alt="Guide" class="included-card-img" />
      <h5 class="included-title-inside">Guide</h5>
      <p class="included-text">A great Socotri guide: professional, fun, and English-speaking. Local guides for the different natural protected areas.</p>
    </div>
    <div class="included-card">
      <img src="{{ url_for('static', filename='images/image.png') }}" alt="Vehicle" class="included-card-img" />
      <h5 class="included-title-inside">Transportation</h5>
      <p class="included-text">Reliable 4x4 car and knowledgeable local driver</p>
    </div>
  </div>

  <div class="not-included">
    <h1 class="not-included-header">What is not Included?</h1>
    <div class="not-included-card">
      <h5 class="not-included-title-inside">International Flights</h5>
      <p class="not-included-text">Airline ticket to and from Abu Dhabi</p>
    </div>
    <div class="not-included-card">
      <h5 class="not-included-title-inside">Roundtrip to Socotra</h5>
      <p class="not-included-text">Abu Dhabi – Socotra roundtrip flight ($980 USD)</p>
    </div>
    <div class="not-included-card">
      <h5 class="not-included-title-inside">Visa</h5>
      <p class="not-included-text">Visa fee ($150 USD)</p>
    </div>
    <div class="not-included-card">
      <h5 class="not-included-title-inside">Insurance</h5>
      <p class="not-included-text">Travel insurance not included</p>
    </div>
    <div class="not-included-card">
      <h5 class="not-included-title-inside">Optional Activities</h5>
      <p class="not-included-text">Extra activities not covered by base tour</p>
    </div>
  </div>

  <!-- Booking Form -->

<div id="booking-form-tour" class="booking-container-tour">
  <h2 class="booking-title-tour">Book the Tour</h2>

  <form method="POST" class="booking-form-tour">
    <input type="hidden" name="csrf_token" value="{{ form.csrf_token._value() }}">

    <!-- Client Name -->
    <div class="form-group-tour">
      <label for="client-name">Name</label>
      <input type="text" class="form-control" id="client-name" name="client_name" value="{{ request.form.client_name or '' }}">
      {% if form.client_name.errors %}
        <div class="invalid-feedback d-block">
          {% for error in form.client_name.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Email -->
    <div class="form-group-tour">
      <label for="client-email">Email</label>
      <input type="email" class="form-control" id="client-email" name="client_email" value="{{ request.form.client_email or '' }}">
      {% if form.client_email.errors %}
        <div class="invalid-feedback d-block">
          {% for error in form.client_email.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Country Code Dropdown -->
    <div class="form-group-tour">
      <label for="country-code">Country Code</label>
      <select class="form-control" id="country-code" name="country_code">
        {% set selected_cc = request.form.country_code or '' %}
        {% for value, label in form.country_code.choices %}
          <option value="{{ value }}" {% if selected_cc == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      {% if form.country_code.errors %}
        <div class="invalid-feedback d-block">
          {% for error in form.country_code.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Phone Number -->
    <div class="form-group-tour">
      <label for="phone-number">Phone Number</label>
      <input type="text" class="form-control" id="phone-number" name="phone_number" value="{{ request.form.phone_number or '' }}">
      {% if form.phone_number.errors %}
        <div class="invalid-feedback d-block">
          {% for error in form.phone_number.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Departure Date Picker -->
    <div class="form-group-tour">
      <label for="departure-picker">Select a Departure Date</label><br>
      <input type="text" id="departure-picker" name="departure_picker" class="form-control" placeholder="Pick a date" value="{{ request.form.departure_picker or '' }}">
      <input type="hidden" id="departure-id" name="departure_id" value="{{ request.form.departure_id or '' }}">
      {% if form.departure_id.errors %}
        <div class="invalid-feedback d-block">
          {% for error in form.departure_id.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Number of Nights -->
    <div class="form-group-tour">
      <label>Number of Nights</label><br>
      {% for subfield in form.number_nights %}
        <div class="form-check">
          <input type="radio" class="form-check-input" id="night-{{ loop.index }}" name="number_nights" value="{{ subfield.data }}"
            {% if subfield.checked or request.form.number_nights == subfield.data %}checked{% endif %}>
          <label class="form-check-label" for="night-{{ loop.index }}">{{ subfield.label.text }}</label>
        </div>
      {% endfor %}
      {% if form.number_nights.errors %}
        <div class="invalid-feedback d-block">
          {% for error in form.number_nights.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Number of People -->
    <div class="form-group-tour">
      <label for="number-people">Number of People</label>
      <input type="number" class="form-control" id="number-people" name="number_people" value="{{ request.form.number_people or '' }}">
      {% if form.number_people.errors %}
        <div class="invalid-feedback d-block">
          {% for error in form.number_people.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Tour Type -->
    <div class="form-group-tour">
      <label for="tour-type">Tour Type</label>
      <select class="form-control" id="tour-type" name="tour_type">
        {% set selected_tour = request.form.tour_type or '' %}
        {% for value, label in form.tour_type.choices %}
          <option value="{{ value }}" {% if selected_tour == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      {% if form.tour_type.errors %}
        <div class="invalid-feedback d-block">
          {% for error in form.tour_type.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Submit Button -->
    <div class="form-group-tour mt-3">
      <button type="submit" class="btn btn-primary">Submit</button>
    </div>
  </form>
</div>


<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="alert-container">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}


<!-- Flatpickr Calendar Integration -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
  /* Just in case: hide any rogue select for departure_id */
  select#departure-id {
    display: none !important;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const departures = JSON.parse('{{ departures_json | tojson | safe }}');

  const availableDates = departures.map(dep => dep.date.split('T')[0]);

  const fp = flatpickr("#departure-picker", {
    dateFormat: "Y-m-d",
    enable: availableDates,
    onChange: function (selectedDates, dateStr) {
      const selected = departures.find(dep => dep.date.split('T')[0] === dateStr);
      if (selected) {
        document.getElementById("departure-id").value = selected.id;
      } else {
        document.getElementById("departure-id").value = "";
      }
    }
  });

  function getUrlParameter(name) {
    name = name.replace(/[\[\]]/g, '\\$&');
    const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
    const results = regex.exec(window.location.href);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  (function preselectDeparture() {
    const preselectedIdFromForm = "{{ form.departure_id.data }}";
    let preselectedId = preselectedIdFromForm || getUrlParameter('departure_id');

    if (preselectedId) {
      preselectedId = preselectedId.toString();
      const matched = departures.find(dep => dep.id.toString() === preselectedId);
      if (matched) {
        fp.setDate(matched.date.split('T')[0], true);
        document.getElementById("departure-id").value = matched.id;
      }
    }
  })();

  (function setTourTypeFromUrl() {
    const tourTitleFromUrl = getUrlParameter('tour_title');
    if (tourTitleFromUrl) {
      const tourTypeSelect = document.getElementById('tour-type');
      if (tourTypeSelect) {
        for (let i = 0; i < tourTypeSelect.options.length; i++) {
          const optionText = tourTypeSelect.options[i].text.toLowerCase().replace(/\s+/g, '');
          const urlTitle = tourTitleFromUrl.toLowerCase().replace(/\s+/g, '');
          if (optionText.includes(urlTitle)) {
            tourTypeSelect.selectedIndex = i;
            break;
          }
        }
      }
    }
  })();

  // Block submission if departure-id is missing
  const form = document.querySelector("form.booking-form-tour");
  const departureIdInput = document.getElementById("departure-id");

  form.addEventListener("submit", function (e) {
    if (!departureIdInput.value) {
      e.preventDefault();
      alert("Please select a departure date.");
      document.getElementById("departure-picker").classList.add("is-invalid");
    }
  });
});
</script>



{% endblock %}
